{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load staticfiles %}
{% load common_tags %} 
{% load humanize %}

{% block title %}
Center Summary
{% endblock %}




{% block content %}

<h1>{% settings_value 'CENTER_NAME' %} Scientific Impact</h1><hr>

<!-- Start  Publications -->
<div class="card mb-3 border-primary">
  <div class="card-header bg-primary text-white">
    <i class="fas fa-newspaper"></i> User Entered Publications
  </div>
  <div class="card-body">
    <div id="chartPublications"></div>
    <strong>Total Publications:</strong> {{total_publications_count}}
  </div>
</div>
<!-- End Publications -->



<!-- Start  Grants -->
<div class="card mb-3 border-primary">
  <div class="card-header bg-primary text-white">
    <i class="fas fa-trophy"></i> User Grants Summary
  </div>
  <div class="card-body">
    <div id="chartGrants"></div>
    <hr>
    <strong> Grants Total:</strong> ${{grants_total}} <br>
    <strong> Grants Total PI Only:</strong> ${{grants_total_pi_only}} <br>
    <strong> Grants Total CoPI Only:</strong> ${{grants_total_copi_only}} <br>
    <strong> Grants Total Senior Personnel Only:</strong> ${{grants_total_sp_only}}
  </div>
  </div>
</div>
<!-- End Grants -->


<!-- Start Subscription by Field of Science -->
<div class="card mb-3 border-primary">
  <div class="card-header bg-primary text-white">
    <i class="fas fa-flask"></i> Active Subscriptions and Users by Field of Science
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table id="fos-table" class="table table-bordered">
        <thead>
          <tr>
            <th>Field of Science</th>
            <th>Active Subscription Count</th>
            <th>User Count</th>
          </tr>
        </thead>
        <tbody>
          {% for key, val in subscriptions_by_fos.items %}
          <tr>
            <td>{{key}}</td>
            <td>{{val}}</td>
            <td>{{active_users_by_fos|get_value_from_dict:key}}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <strong>Total Active Users: {{total_subscriptions_users}}</strong>
    <br>
    <strong>Total Active Principle Investigators: {{active_pi_count}}</strong>
  </div>
</div>
</div>
<!-- End Subscription by Field of Science -->



<!-- Start Subscription Charts -->
<div class="card mb-3 border-primary">
  <div class="card-header bg-primary text-white">
    <i class="fas fa-trophy"></i> Resources and Subscriptions Summary
  </div>
  <div class="card-body">
    <div class="row">
    <div class="col">
      <div id="chartSubscriptions" style="min-height: 270px;"></div>
      <div id="chartResources" style="min-height: 270px;"></div>
    </div>

    <div class="col">
      <div class="table-responsive">
        <table id="resource-table" class="table table-bordered table-condensed table-hover">
          <thead>
            <tr>
              <th>Resource Name (Type)</th>
              <th>Active Subscription Count</th>
            </tr>
          </thead>
          <tbody>
            {% for resource, resource_subscription_count in subscriptions_count_by_resource.items %}
            <tr>
              <td>{{resource.name}} <strong>({{resource.resource_type.name}})</strong></td>
              <td>{{resource_subscription_count}}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  </div>
</div>
</div>
<!-- End Subscription Charts -->

 <script>
  $("#navbar-main > ul > li.active").removeClass("active")
  $("#navbar-center-summary").addClass("active")



    $(document).ready(function() { 
     $('#fos-table').DataTable({
            "iDisplayLength": 10,
            "bSortClasses": false,
            "order": [[ 1, "desc" ]]
    });
     $('#resource-table').DataTable({
            "iDisplayLength": 10,
            "bSortClasses": false,
            "order": [[ 1, "desc" ]]
        });


    drawPublications();
    drawGrantsByAgency();
    drawSubscriptions();
    drawResources();

    });
  function drawPublications() {
          var chart = c3.generate({
              bindto: '#chartPublications',
              data: publication_by_year_bar_chart_data,
              legend: {
                  show: false,
                  item: {
                      onclick: function(id) {}
                  }
              },
              axis: {
                  x: {
                  label: {
                    text: 'Year',
                    position: 'outer-center'
                  }
                },
                y: {
                  label: 'Number of Publications',
                  position: 'outer-middle'
                }
              }
          });
      }

      function drawGrantsByAgency() {
        var chart = c3.generate({
            bindto: '#chartGrants',
            data: grants_agency_chart_data,
            donut: {
                title: "Grants"
            },
            legend: {
                item: {
                    onclick: function(id) {}
                }
            }
        });
    }

    function drawSubscriptions() {
        var chart = c3.generate({
            bindto: '#chartSubscriptions',
            donut: {
                title: "Subscriptions"
            },
            data: subscriptions_chart_data,
            legend: {
                item: {
                    onclick: function(id) {}
                }
            }
        });
    }
    function drawResources() {
        var chart = c3.generate({
            bindto: '#chartResources',
            data: resources_chart_data,
            donut: {
                title: "Active by Type"
            },
            legend: {
                item: {
                    onclick: function(id) {}
                }
            }
        });
    }


    var grants_agency_chart_data = {{ grants_agency_chart_data | safe }}
    var publication_by_year_bar_chart_data = {{ publication_by_year_bar_chart_data | safe }}
    var subscriptions_chart_data = {{ subscriptions_chart_data | safe }}
    var resources_chart_data = {{ resources_chart_data | safe }}

</script>
{% endblock %}
